{% extends 'base.html' %}

{% block title %}编辑商品 - {{ product.name }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="fw-bold">编辑商品</h2>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- 商品信息 -->
        <div class="card p-4 mt-4 shadow-sm">
            <h4 class="fw-bold">商品信息</h4>
            <div class="row g-3">
                <div class="col-md-6">
                    {{ product_form.name.label_tag }}
                    {{ product_form.name }}
                    {% if product_form.name.errors %}
                        <div class="alert alert-danger mt-2">
                            {% for error in product_form.name.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-12">
                    {{ product_form.description.label_tag }}
                    {{ product_form.description }}
                    {% if product_form.description.errors %}
                        <div class="alert alert-danger mt-2">
                            {% for error in product_form.description.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    {{ product_form.hidden.label_tag }}
                    {{ product_form.hidden }}
                    {% if product_form.hidden.errors %}
                        <div class="alert alert-danger mt-2">
                            {% for error in product_form.hidden.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    {{ product_form.is_physical.label_tag }}
                    {{ product_form.is_physical }}
                    {% if product_form.is_physical.errors %}
                        <div class="alert alert-danger mt-2">
                            {% for error in product_form.is_physical.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    {{ product_form.stock_quantity.label_tag }}
                    {{ product_form.stock_quantity }}
                    {% if product_form.stock_quantity.errors %}
                        <div class="alert alert-danger mt-2">
                            {% for error in product_form.stock_quantity.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                        {{ product_form.sku.label_tag }}
                        {{ product_form.sku }}
                        <button type="button" class="btn btn-secondary btn-sm" id="generate-sku">生成 SKU</button>
                        {% if product_form.sku.errors %}
                            <div class="alert alert-danger mt-2">
                                {% for error in product_form.sku.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>


        </div>

        <h5 class="mt-4 fw-bold">选择商品分类</h5>
        <div class="row g-3">
            <div class="col-md-4">
                <label>一级分类</label>
                <select id="id_category_level1" name="category_level1" class="form-control">
                    <option value="">选择一级分类</option>
                    {% for category in categories_level1 %}
                        <option value="{{ category.id }}" {% if product.category_level1 and product.category_level1.id == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-warning btn-sm mt-2" id="custom-category1">自定义</button>
                <input type="text" id="custom_category_level1" name="custom_category_level1"
                       value="{{ product_form.custom_category_level1.value|default_if_none:'' }}"
                       class="form-control mt-2 {% if not product_form.custom_category_level1.value %}d-none{% endif %}"
                       placeholder="输入自定义分类">
                {% if product_form.category_level1.errors %}
                    <div class="alert alert-danger mt-2">
                        {% for error in product_form.category_level1.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="col-md-4">
                <label>二级分类</label>
                <select id="id_category_level2" name="category_level2" class="form-control" {% if not product.category_level2 %}disabled{% endif %}>
                    {% if product.category_level2 %}
                        <option value="{{ product.category_level2.id }}">{{ product.category_level2.name }}</option>
                    {% else %}
                        <option value="">选择二级分类</option>
                    {% endif %}
                </select>
                <button type="button" class="btn btn-warning btn-sm mt-2" id="custom-category2" {% if not product.category_level2 %}disabled{% endif %}>自定义</button>
                <input type="text" id="custom_category_level2" name="custom_category_level2"
                       value="{{ product_form.custom_category_level2.value|default_if_none:'' }}"
                       class="form-control mt-2 {% if not product_form.custom_category_level2.value %}d-none{% endif %}"
                       placeholder="输入自定义分类">
                {% if product_form.category_level2.errors %}
                    <div class="alert alert-danger mt-2">
                        {% for error in product_form.category_level2.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="col-md-4">
                <label>三级分类</label>
                <select id="id_category_level3" name="category_level3" class="form-control" {% if not product.category_level3 %}disabled{% endif %}>
                    {% if product.category_level3 %}
                        <option value="{{ product.category_level3.id }}">{{ product.category_level3.name }}</option>
                    {% else %}
                        <option value="">选择三级分类</option>
                    {% endif %}
                </select>
                <button type="button" class="btn btn-warning btn-sm mt-2" id="custom-category3" {% if not product.category_level3 %}disabled{% endif %}>自定义</button>
                <input type="text" id="custom_category_level3" name="custom_category_level3"
                       value="{{ product_form.custom_category_level3.value|default_if_none:'' }}"
                       class="form-control mt-2 {% if not product_form.custom_category_level3.value %}d-none{% endif %}"
                       placeholder="输入自定义分类">
                {% if product_form.category_level3.errors %}
                    <div class="alert alert-danger mt-2">
                        {% for error in product_form.category_level3.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>


        <!-- 推荐标签 -->
        <div class="card p-3 mt-4 shadow-sm" id="recommended-tags-card" style="display: none;">
            <h5 class="fw-bold">推荐标签</h5>
            <div id="recommended-tags" class="d-flex flex-wrap gap-2"></div>

            <!-- 用户填写标签内容 -->
            <div id="tag-input-container" style="display: none;">
                <div class="d-flex gap-2 mt-3">
                    <input type="text" id="tag-input" class="form-control" placeholder="请输入标签内容">
                    <button type="button" id="add-tag-btn" class="btn btn-primary">添加标签</button>
                </div>
            </div>
        </div>

        <!-- 已添加的标签 -->
        <div class="card p-3 mt-3 shadow-sm" id="added-tags-card" {% if not product.attributes.exists %}style="display: none;"{% endif %}>
            <h5 class="fw-bold">已添加标签</h5>
            <div id="added-tags" class="d-flex flex-wrap gap-2">
                {% for attr in product.attributes.all %}
                    <span class="badge bg-success text-white px-2 py-1 rounded d-flex align-items-center">
                        {{ attr.key }}: {{ attr.value }}
                        <button type="button" class="btn btn-danger btn-sm ms-2" onclick="removeExistingTag('{{ attr.id }}', this)">删除</button>
                    </span>
                {% endfor %}
            </div>
        </div>

        <!-- 隐藏字段 -->
        <input type="hidden" name="tags" id="tags-input">
        <input type="hidden" name="delete_tags" id="delete-tags-input">


        <!-- 定价信息 -->
        <div class="card p-4 mt-4 shadow-sm">
            <h4 class="fw-bold">定价信息</h4>
            <div class="mb-3">
                {{ pricing_form.price.label_tag }} <!-- 显示价格标签 -->
                {{ pricing_form.price }} <!-- 显示价格输入框 -->
                {% if pricing_form.price.errors %}
                    <div class="alert alert-danger mt-2">
                        {% for error in pricing_form.price.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>



        <!-- 主图替换 -->
        <div class="card p-4 mt-4 shadow-sm">
            <h4 class="fw-bold">主图替换</h4>
            <div class="mb-3" id="primary-image-container">
                {% for product_image in product.images.all %}
                    {% if product_image.is_primary %}
                        <div class="image-item mb-2" id="primary-image">
                            <img src="{{ product_image.image.url }}" alt="Product Primary Image" width="100">
                            <label for="replace-primary-image" class="d-block mt-2">替换主图</label>
                            <input type="file" name="replace_primary_image" class="form-control">
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- 非主图管理 -->
        <div class="card p-4 mt-4 shadow-sm">
            <h4 class="fw-bold">其他图片管理</h4>
            <div class="mb-3" id="non-primary-image-container">
                <h5>已上传的非主图</h5>
                {% for product_image in product.images.all %}
                    {% if not product_image.is_primary %}
                        <div class="image-item mb-2" id="image-{{ product_image.id }}">
                            <img src="{{ product_image.image.url }}" alt="Product Image" width="100">
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteImage({{ product_image.id }})">删除图片</button>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="card p-4 mt-4 shadow-sm">
            <h4 class="fw-bold">上传更多图片</h4>
            <div id="additional-images"></div>
            <button type="button" class="btn btn-info" id="add-image-btn">添加更多图片</button>
        </div>

        <button type="submit" class="btn btn-primary mt-3">保存修改</button>
        <a href="{% url 'merchant:product_list' %}" class="btn btn-secondary mt-3">返回</a>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // SKU 生成逻辑
    const skuField = document.querySelector("#id_sku");
    function generateSKU() {
        return "SKU-" + Math.random().toString(36).substr(2, 8).toUpperCase();
    }
    document.getElementById("generate-sku").addEventListener("click", function () {
        skuField.value = generateSKU();
    });

    // 分类级联逻辑
    const level1Field = document.querySelector("#id_category_level1");
    const level2Field = document.querySelector("#id_category_level2");
    const level3Field = document.querySelector("#id_category_level3");

    const customCategory1 = document.querySelector("#custom-category1");
    const customCategory2 = document.querySelector("#custom-category2");
    const customCategory3 = document.querySelector("#custom-category3");

    const customInput1 = document.querySelector("#custom_category_level1");
    const customInput2 = document.querySelector("#custom_category_level2");
    const customInput3 = document.querySelector("#custom_category_level3");

    function fetchSubcategories(parentId, level, targetField, customBtn) {
        fetch(`/merchant/get_subcategories/?parent_id=${parentId}&level=${level}`)
            .then(response => response.json())
            .then(data => {
                targetField.innerHTML = '<option value="">选择分类</option>';
                if (data.length > 0) {
                    data.forEach(item => {
                        targetField.add(new Option(item.name, item.id));
                    });
                    targetField.disabled = false;
                    customBtn.disabled = false;
                } else {
                    targetField.disabled = true;
                    customBtn.disabled = true;
                }
            });
    }

    level1Field?.addEventListener("change", function () {
        const selectedOption = this.options[this.selectedIndex];
        const name = selectedOption.text;

        level2Field.innerHTML = '<option value="">选择二级分类</option>';
        level3Field.innerHTML = '<option value="">选择三级分类</option>';
        level2Field.disabled = true;
        level3Field.disabled = true;
        customCategory2.disabled = true;
        customCategory3.disabled = true;

        if (this.value) {
            fetchSubcategories(this.value, 2, level2Field, customCategory2);
            if (name) fetchRecommendedTags(name);
        }
    });

    level2Field?.addEventListener("change", function () {
        level3Field.innerHTML = '<option value="">选择三级分类</option>';
        level3Field.disabled = true;
        customCategory3.disabled = true;

        if (this.value) {
            fetchSubcategories(this.value, 3, level3Field, customCategory3);
        }
    });

    function enableCustomCategory(level) {
        if (level === 1) {
            level1Field.disabled = true;
            level2Field.disabled = true;
            level3Field.disabled = true;
            customInput1.classList.remove("d-none");
            customInput2.classList.remove("d-none");
            customInput3.classList.remove("d-none");
        } else if (level === 2) {
            level2Field.disabled = true;
            level3Field.disabled = true;
            customInput2.classList.remove("d-none");
            customInput3.classList.remove("d-none");
        } else if (level === 3) {
            level3Field.disabled = true;
            customInput3.classList.remove("d-none");
        }

        skuField.value = generateSKU();
        document.querySelector("#recommended-tags-card").style.display = "none";
    }

    customCategory1?.addEventListener("click", function () { enableCustomCategory(1); });
    customCategory2?.addEventListener("click", function () { enableCustomCategory(2); });
    customCategory3?.addEventListener("click", function () { enableCustomCategory(3); });

    // 自动加载推荐标签（用于编辑页初始加载时）
    const selectedOption = level1Field.options[level1Field.selectedIndex];
    if (selectedOption && selectedOption.value) {
        fetchRecommendedTags(selectedOption.text);
    }

    // 标签逻辑
    let newTags = [];
    let deleteTags = [];

    document.querySelector("#add-tag-btn").addEventListener("click", function () {
        const tagInput = document.querySelector("#tag-input");
        const tagKey = this.dataset.tag;
        const tagValue = tagInput.value.trim();

        if (tagValue) {
            const tagText = `${tagKey}: ${tagValue}`;
            newTags.push(tagText);
            updateTagsInput();

            const tagContainer = document.querySelector("#added-tags");
            const tagEl = document.createElement("span");
            tagEl.className = "badge bg-success text-white px-2 py-1 rounded d-flex align-items-center mt-1";
            tagEl.innerHTML = `${tagText}<button type="button" class="btn btn-danger btn-sm ms-2" onclick="this.parentElement.remove(); removeNewTag('${tagText}')">删除</button>`;
            tagContainer.appendChild(tagEl);

            document.querySelector("#added-tags-card").style.display = "block";
            tagInput.value = "";
            document.querySelector("#tag-input-container").style.display = "none";
        }
    });

    function updateTagsInput() {
        document.getElementById("tags-input").value = newTags.join(",");
    }

    function removeNewTag(tag) {
        newTags = newTags.filter(t => t !== tag);
        updateTagsInput();
    }

    window.removeExistingTag = function (id, el) {
        deleteTags.push(id);
        document.getElementById("delete-tags-input").value = deleteTags.join(",");
        el.parentElement.remove();
    }

    function fetchRecommendedTags(categoryName) {
        fetch(`/merchant/get_recommended_tags/?category_name=${encodeURIComponent(categoryName)}`)
            .then(response => response.json())
            .then(data => {
                const tagContainer = document.querySelector("#recommended-tags");
                const tagCard = document.querySelector("#recommended-tags-card");
                tagContainer.innerHTML = "";

                if (data.length > 0) {
                    tagCard.style.display = "block";
                    data.forEach(tag => {
                        const tagElement = document.createElement("span");
                        tagElement.classList.add("badge", "bg-primary", "text-white", "px-2", "py-1", "rounded");
                        tagElement.textContent = tag;

                        tagElement.addEventListener("click", function () {
                            document.querySelector("#tag-input-container").style.display = "block";
                            const tagInput = document.querySelector("#tag-input");
                            tagInput.value = "";
                            tagInput.placeholder = `${tag}：请输入内容`;
                            document.querySelector("#add-tag-btn").dataset.tag = tag;
                        });

                        tagContainer.appendChild(tagElement);
                    });
                } else {
                    tagCard.style.display = "none";
                }
            });
    }

    // 添加图片输入框
    document.getElementById("add-image-btn").addEventListener("click", function () {
        const div = document.createElement("div");
        div.className = "mt-2";
        div.innerHTML = `<input type="file" name="images" class="form-control" required>
                         <button type="button" class="btn btn-danger btn-sm mt-1" onclick="this.parentElement.remove()">删除</button>`;
        document.getElementById("additional-images").appendChild(div);
    });

    // 删除已有图片
    window.deleteImage = function (imageId) {
        if (!confirm("确定要删除此图片？")) return;
        fetch("", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `delete_image=${imageId}`
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === "success") {
                const el = document.getElementById("image-" + imageId);
                if (el) el.remove();
            } else {
                alert(data.message || "删除失败");
            }
        });
    };
});
</script>

{% endblock %}
